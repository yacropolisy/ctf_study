# ARM アーキテクチャ

参考：

[Qiitaのまとめ](https://qiita.com/edo_m18/items/a7c747c5bed600dca977 )

[ももテク](http://inaz2.hatenablog.com/entry/2015/03/06/020239 )

上の二つに目を通せばだいたい理解できる。



命令:

https://www.mztn.org/slasm/arm03.html

## ディスアセンブル

IDAでできるらしいが、MACでIDA DemoとIDA Freeを試したが無理だった。

`objdump -D ファイル名` でもできるが、長くなるので地獄。

gdb-peda のpdisas も使える。

radare2を使うのが良さげ。



## レジスタ

### 汎用レジスタ

**pcは演算の際、現在実行している命令のアドレス+8として評価される**

| レジスタ | 別名 | _    | 説明                                                   |
| :------- | :--- | :--- | :----------------------------------------------------- |
| r0       | a1   | -    | 汎用レジスタ                                           |
| r1       | a2   | -    | 汎用レジスタ                                           |
| r2       | a3   | -    | 汎用レジスタ                                           |
| r3       | a4   | -    | 汎用レジスタ                                           |
| r4       | v1   | -    | 汎用レジスタ                                           |
| r5       | v2   | -    | 汎用レジスタ                                           |
| r6       | v3   | -    | 汎用レジスタ                                           |
| r7       | v4   | wr   | 汎用レジスタ                                           |
| r8       | v5   | -    | 汎用レジスタ                                           |
| r9       | v6   | sb   | 汎用レジスタ                                           |
| r10      | v7   | sl   | 汎用レジスタ                                           |
| r11      | v8   | fp   | 汎用レジスタ、フレームポインタ (EBP)                   |
| r12      | ip   | -    | 汎用レジスタ、プロシージャ内呼び出しスクラッチレジスタ |
| r13      | sp   | -    | 汎用レジスタ、スタックポインタ (ESP)                   |
| r14      | lr   | -    | リンクレジスタ (リターンアドレス)                      |
| r15      | pc   | -    | プログラムカウンタ (EIP)                               |



### ステータスレジスタ

| bit  | フラグ | 意味             | 備考                            |
| :--- | :----- | :--------------- | :------------------------------ |
| 31   | N      | ネガティブ       | ２の補数表現で負なら１          |
| 30   | Z      | ゼロ             | ゼロなら１                      |
| 29   | C      | キャリー／ボロー | 無符号加減算の桁あふれの時１    |
| 28   | V      | オーバーフロー   | 符号付加減算の桁あふれの時１    |
| 27   | Q      | オーバーフロー   | オーバーフロー、飽和(DSP)の時１ |



## 条件指定実行

| 条件 (<cd>) | 意味                        | フラグ条件           |
| :---------- | :-------------------------- | :------------------- |
| AL          | 無条件に実行                | 無条件               |
| EQ          | 等しい                      | Zセット              |
| NE          | 等しくない                  | Zクリア              |
| MI          | 負                          | Nセット              |
| PL          | 正かゼロ                    | Nクリア              |
| VS          | オーバフロー                | Vセット              |
| VC          | オーバフローでない          | Vクリア              |
| CS/HS       | ≧ 大きいか等しい (符号無し) | Cセット              |
| CC/LO       | ＜ 小さい (符号無し)        | Cクリア              |
| HI          | ＞ 大きい (符号無し)        | CセットかつZクリア   |
| LS          | ≦ 小さいか等しい (符号無し) | CクリアまたはZセット |
| GE          | ≧ 大きいか等しい (符号付き) | NとVが同じ           |
| LT          | ＜ 小さい (符号付き)        | NとVが異なる         |
| GT          | ＞ 大きい (符号付き)        | GEの条件かつZクリア  |
| LE          | ≦ 小さいか等しい (符号付き) | LTの条件かつZクリア  |



## 演算命令

コメントは`@` , 数値は`#1`, `#2` のように`#` をつけて表す。

```assembly
add r1, r2, r3 @ r1 = r2 + r3
```

シフト演算も含めて指定できる。

```assembly
add r1, r2, r3 LSL #20 @ r1 = r2 + (r3 << 20)
```



### シフト演算

| 命令 | 意味                                                      |
| :--- | :-------------------------------------------------------- |
| LSL  | (Logical Shift Left) 左シフト                             |
| LSR  | (Logical Shift Right) 右シフト                            |
| ASR  | (Arithmetic Shift Right) 算術右シフト(符号を保存)         |
| ROR  | (Rotate Right) 右ローテイト                               |
| RRX  | (Rotate Right with extend) 右ローテイト(含キャリーフラグ) |



## ロード／ストア命令

| 動作                | 命令 |
| :------------------ | :--- |
| レジスタ → レジスタ | MOV  |
| メモリ→ レジスタ    | LDR  |
| レジスタ→メモリ     | STR  |



## プログラム例

```assembly
#-------------------------------------
# プログラム例 list01.s
#-------------------------------------

#-------------------------------------
# text セクション
#-------------------------------------
.text
       .align  2
       .global _start           @ 必須

/* 定数に名前をつける */

sys_write = 0x900004            @ write システムコール
sys_exit  = 0x900001            @ exit システムコール

/* ここからプログラムを記述 */

_start: /* 常にこのラベルから実行開始 */


        mov     r3, #5          @ 5回繰り返す
    1:  ldr     r1, msg         @ 文字列先頭アドレス
        mov     r0, #1          @ 標準出力(fd=1)を指定
        ldr     r2, msg_sz      @ 出力データの長さ(バイト)
        swi     #sys_write
        subs    r3, r3, #1      @ カウンタを更新
        bne     1b              @ 後方のローカルラベルへ

        /* プログラム終了時に実行する */

        mov     r0, #0          @ 終了コードを0
        swi     #sys_exit       @ プログラム終了

        /* 書き換え不要な定数は text セクションに置く */

msg:    .long   msg0            @ 文字列格納アドレス
msg_sz: .long   msg_sz0         @ 文字列の長さ格納アドレス

#-------------------------------------
# data セクション
#-------------------------------------
.data
        .align  2
        /* ここは初期化が必要なデータを置く *
         * プログラムサイズに影響する       */

msg0:   .asciz  "hello, world\n"

        .align  2               @ 4バイト境界に設定
msg_sz0 = . - msg0              @ 文字列の長さを計算

data1:  .hword  12345

#-------------------------------------
# bss セクション
#-------------------------------------
.bss
        .align  2
        /* ここは初期化が不要なデータを置く *
         * プログラムサイズには影響しない   */

data:   .long   0               @ この例では使っていない
#-------------------------------------
```

 